<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby</title>
    {% load static %}
    <style>
        body {
            background-image: url("https://res.cloudinary.com/dwfdyavop/image/upload/v1728701605/r3_bg_rwkndx.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* Styling for highlighted option */
        .selected {
            background-color: #7db9e8 !important;
            box-shadow: 0px 0px 12px rgba(0, 0, 0, 0.5);
            border: 2px solid #0000ff;
        }

        /* Timer styling */
        #timer {
            font-size: 24px;
            font-weight: bold;
            margin: 20px;
            text-align: center;
        }

        /* Form container styling */
        #form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
            width: 80%;
            margin: 40px auto;
        }

        /* Button styling */
        #form button {
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid #000;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        #form button:hover {
            background-color: #7db9e8;
            color: white;
        }

        /* Other CSS */
    </style>
    <link rel="stylesheet" type="text/css" href="{% static 'css/r3_quest.css' %}">
</head>
<body>

    <div id="quest"></div>
    <div id="timer">10.000</div> <!-- Timer display with three decimal places -->

    <form id="form">
        <button type="button" onclick="sendMessage(1)"><div id="option1">Option 1</div></button>
        <button type="button" onclick="sendMessage(2)"><div id="option2">Option 2</div></button>
        <button type="button" onclick="sendMessage(3)"><div id="option3">Option 3</div></button>
        <button type="button" onclick="sendMessage(4)"><div id="option4">Option 4</div></button>
    </form>

    <div id="messages"></div>

    <script type="text/javascript">
        let cnt = 0;
        let url = `ws://${window.location.host}/ws/socket-server/`;
        const chatSocket = new WebSocket(url);
        let permit = false;
        let countdown;
        let timeLeft = 10.000; // Start countdown from 10 seconds
        let isDisconnected = false; // Flag to track if WebSocket is already disconnected
        
        function clearMessages() {
            document.getElementById("messages").innerHTML = ''; // Clears all messages
        }

        // Timer logic with milliseconds
        function startTimer() {
            const interval = 10; // Interval in milliseconds (0.01 seconds)
            countdown = setInterval(() => {
                timeLeft -= interval / 1000; // Subtract 0.01 seconds from timeLeft
                document.getElementById("timer").innerText = timeLeft.toFixed(3); // Show time with 3 decimal places
    
                // If time runs out, stop the timer and disconnect
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    document.getElementById("timer").innerText = "0.000"; // Display "0.000" when time runs out
                    sendMessage(0);  // Send message indicating time's up
                    permit = false;
                }
            }, interval);
        }
    
        // Disconnect WebSocket
        function disconnectSocket() {
            if (!isDisconnected) {
                chatSocket.close(); // Close the WebSocket connection
                isDisconnected = true; // Set flag to avoid multiple closures
            }
        }
        
        function clearMessages() {
            document.getElementById("messages").innerHTML = ''; // Clears all messages
            document.getElementById('quest').innerHTML = '';
            document.getElementById('option1').innerHTML = '';
            document.getElementById('option2').innerHTML = '';
            document.getElementById('option3').innerHTML = '';
            document.getElementById('option4').innerHTML = '';
        }

        chatSocket.onmessage = function(e) {
            let data = JSON.parse(e.data);
            console.log('Data:', data);
    
            // Check if data.play is true to start the timer
            if (data.play === true) {
                startTimer();
                permit = true;
                timeLeft = 10.000;
                clearMessages();
            }
    
            if(data.type === 'chat'){
                if(data.option1 != undefined){
                    let messages = document.getElementById('messages');
                    let quest = document.getElementById('quest');
                    let option1 = document.getElementById('option1');
                    let option2 = document.getElementById('option2');
                    let option3 = document.getElementById('option3');
                    let option4 = document.getElementById('option4');
                    
                    if(data.message != undefined) {
                        messages.insertAdjacentHTML('beforeend', `<div><p>${data.message}</p></div>`);
                    }
                    
                    cnt = data.counter;
                    quest.insertAdjacentHTML('beforeend', `<div><p>${data.quest}</p></div>`);
                    option1.innerHTML = data.option1;
                    option2.innerHTML = data.option2;
                    option3.innerHTML = data.option3;
                    option4.innerHTML = data.option4;
                } 
            }
        };
    
        function sendMessage(option) {
            if (!isDisconnected && permit === true) {
                clearInterval(countdown); // Stop the timer when an option is chosen
    
                let message;
                switch (option) {
                    case 1:
                        message = "A. Option 1";
                        break;
                    case 2:
                        message = "B. Option 2";
                        break;
                    case 3:
                        message = "C. Option 3";
                        break;
                    case 4:
                        message = "D. Option 4";
                        break;
                    case 0:
                        message = "Time's up!";
                        break;
                    default:
                        message = "Unknown option";
                }
    
                let tm = "{{team.team_name}}"; // Assuming this is set dynamically in your Django template
    
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'team': tm,
                    'option': option,
                    'cnt': cnt,
                    'time': timeLeft.toFixed(3)  // Send the remaining time with 3 decimal places
                }));
                permit = false;
            }
        }
    
        // WebSocket on close event (optional for cleanup)
        chatSocket.onclose = function(e) {
            console.log('WebSocket closed:', e);
        };
    </script>
    
</body>
</html>
