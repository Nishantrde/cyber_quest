<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby</title>
    {% load static %}
    <style>
        body {
            background-image: url("{% static 'img/r3_bg.jpg' %}");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        #messages {
        max-height: 300px; /* Set a reasonable height for the message box */
        overflow-y: auto;  /* Scrollbar only if necessary */
        transition: max-height 0.3s ease;
    }

    /* When the timer is over, remove the scroll */
    #messages.no-scroll {
        max-height: none;   /* Remove the height limit */
        overflow-y: hidden; /* Disable scrolling */
    }

    </style>
    <link rel="stylesheet" type="text/css" href="{% static 'css/r3_quest.css' %}">
</head>
<body>
    <h1 id="heading">Buzzer Round</h1>
    <div id="answer"></div>
    <div class="leader-board">
        <h2>LEADER BOARD</h2>
        {% for team in teams %}
            <div class="team-score">
                <span class="team-name">{{ team }}</span>
                <span class="team-score">{{ team.score }}</span>
            </div>
        {% endfor %}
    </div>
    
    <div class="container">
        <div class="question-text">
            <h2>{{ quest.quest }}</h2>
        </div>

        <div class="option-container">
            <div class="option-box" data-option="1">
                <span class="option-label option-a">A</span>
                <span class="option-text">{{ quest.option1 }}</span>
            </div>
            <div class="option-box" data-option="1">
                <span class="option-label option-b">B</span>
                <span class="option-text">{{ quest.option2 }}</span>
            </div>
            <div class="option-box" data-option="1">
                <span class="option-label option-c">C</span>
                <span class="option-text">{{ quest.option3 }}</span>
            </div>
            <div class="option-box" data-option="1">
                <span class="option-label option-d">D</span>
                <span class="option-text">{{ quest.option4 }}</span>
            </div>
        </div>

        <div id="messages"></div>
        <div id="timer">10.000</div> <!-- Timer display -->
    </div>
    <div class="status-bar">
        <div class="question-counter">Question {{ counter }} of 8</div>
    </div>

    <div class="progress-bar">
        <div class="progress" id="progress"></div>
    </div>

    <form method="post" id="quiz-form" action="/r3_quest_lrbd/{{count}}">
        {% csrf_token %}
        <input type="hidden" name="pro_lst" id="pro_lst" value="">
        <input type="hidden" name="dep_lst" id="dep_lst" value="">

        </form>

    <script type="text/javascript">
        const form = document.getElementById('quiz-form');
        const ProInput = document.getElementById('pro_lst');
        const DepInput = document.getElementById('dep_lst');

        let pro_lst = [];
        let dep_lst = [];
        // Timer and progress logic here...
        const progressBar = document.getElementById('progress');
            const totalQuestions = 8;
            const currentQuestion = parseInt('{{ counter }}', 10);
    
            if (totalQuestions > 0 && currentQuestion > 0) {
                const progressPercent = (currentQuestion / totalQuestions) * 100;
                if (progressPercent <= 100 && progressPercent >= 0) {
                    progressBar.style.width = progressPercent + '%';
                }
            }
        let url = `ws://${window.location.host}/ws/socket-server/`;
        const chatSocket = new WebSocket(url);
        let countdown;
        let timeRemaining = 10000; // 10 seconds in milliseconds
        let isRunning = false; 
        let timerInterval;

        function clearMessages() {
            document.getElementById("messages").innerHTML = '';
        }

        function updateTimerDisplay() {
            let seconds = (timeRemaining / 1000).toFixed(3);
            document.getElementById('timer').textContent = seconds;
        }

        function startTimer() {
    if (!isRunning) {
        timerInterval = setInterval(() => {
            if (timeRemaining > 0) {
                timeRemaining -= 10;
                updateTimerDisplay();
            } else {
                clearInterval(timerInterval);
                isRunning = false;
                showTimerOverMessage();  // Call the function to show message when timer is over
                removeOptionsAndQuestion();  // Call the function to remove options and question
            }
        }, 10);
        isRunning = true;
    }
}

function showTimerOverMessage() {
    let messages = document.getElementById('messages');
    let answer = document.getElementById('answer');

    // Add the no-scroll class when the timer is over
    messages.classList.add('no-scroll');

    let messageHTML = `
    <h1 id="heading">{{quest}}</h1>
        <h1 id="heading">Answer: {{ans}}</h1>
    `;
    answer.insertAdjacentHTML('beforeend', messageHTML);
}


function removeOptionsAndQuestion() {
    // Remove the question text and option containers
    document.querySelector('.question-text').style.display = 'none';
    document.querySelector('.option-container').style.display = 'none';
}


        function pauseTimer() {
            clearInterval(timerInterval);
            isRunning = false;
        }

        function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                timeRemaining = 10000;
                event.preventDefault(); 
                toggleTimer();
                chatSocket.send(JSON.stringify({
                    'message': "kernel",
                    'play': true,
                    'quest': `{{quest}}`,
                    'option1': '{{quest.option1}}',
                    'option2': '{{quest.option2}}',
                    'option3': '{{quest.option3}}',
                    'option4': '{{quest.option4}}',
                    'counter': '{{counter}}'
                }));
                clearMessages();
            }

            if (event.code === 'Enter') {
                ProInput.value = JSON.stringify(pro_lst);  // Serialize pro_lst
                DepInput.value = JSON.stringify(dep_lst);  // Serialize dep_lst
                form.submit();
                // window.location.href = `/r3_quest_lrbd/{{count}}`;
            }

        });

        let i = 0; // Initial decrement counter

    chatSocket.onmessage = function(e) {
        let data = JSON.parse(e.data);
        let messages = document.getElementById('messages');
        
        if (data.team !== undefined) {
            let tm = data.time;
            let reactionTime = (10.0 - tm).toFixed(3);
            
            // Calculate the score dynamically: start with 50 and decrease by i if score is positive
            let displayedScore = (data.score >= 0) ? 50 - i : data.score;
            
            if (data.score >= 0) {
                // Increase the counter for the next player
                i += 10;
                pro_lst.push({"team": data.team, "time": tm});
            } else {
                dep_lst.push({"team": data.team});
            }

            // Create the HTML for a creative message display with conditional styling
            let messageHTML = `
                <div class="message-box">
                    <h3 class="team-name">${data.team}</h3>
                    <p class="reaction-time">Reaction Time: <strong>${reactionTime} seconds</strong></p>
                    <p class="team-score">
                        Score: <strong style="color: ${displayedScore >= 0 ? '#00FF00' : '#FF4500'};">${displayedScore}</strong>
                    </p>
                </div>
            `;

            messages.insertAdjacentHTML('beforeend', messageHTML);
        }
    };

    // Styling for the messages
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        .message-box {
            border: 2px solid #4CAF50;
            background-color: rgba(0, 0, 0, 0.7);
            color: #FFF;
            margin: 10px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease-in-out;
            animation: fadeIn 0.5s ease;
        }
        .team-name {
            font-size: 1.5em;
            margin: 0;
            color: #FFD700;
        }
        .reaction-time {
            font-size: 1.2em;
            margin: 0;
            color: #00FF00;
        }
        .team-score {
            font-size: 1.2em;
            margin: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(styleElement);

        window.onload = function() {
            updateTimerDisplay();
        };
    </script>
</body>
</html>
