<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby</title>
    {% load static %}
    <style>
        body {
            background-image: url("https://res.cloudinary.com/dwfdyavop/image/upload/v1728701605/r3_bg_rwkndx.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

    </style>
    <link rel="stylesheet" type="text/css" href="{% static 'css/r3_quest.css' %}">
</head>
<body>
    <div class="leader-board">
        <h2>LEADER BOARD</h2>
        {% for team in teams %}
            <div class="team-score">
                <span class="team-name">{{ team }}</span>
                <span class="team-score">{{ team.score }}</span>
            </div>
        {% endfor %}
    </div>
    
    <div class="container">
        <div class="question-text">
            <h2>{{ quest.quest }}</h2>
        </div>

        <div class="option-container">
            <div class="option-box" data-option="1">
                <span class="option-label option-a">A</span>
                <span class="option-text">{{ quest.option1 }}</span>
            </div>
            <div class="option-box" data-option="1">
                <span class="option-label option-b">B</span>
                <span class="option-text">{{ quest.option2 }}</span>
            </div>
            <div class="option-box" data-option="1">
                <span class="option-label option-c">C</span>
                <span class="option-text">{{ quest.option3 }}</span>
            </div>
            <div class="option-box" data-option="1">
                <span class="option-label option-d">D</span>
                <span class="option-text">{{ quest.option4 }}</span>
            </div>
        </div>

        <div id="messages"></div>
        <div id="timer">10.000</div> <!-- Timer display -->
    </div>
    <div class="status-bar">
        <div class="question-counter">Question {{ counter }} of 8</div>
    </div>

    <div class="progress-bar">
        <div class="progress" id="progress"></div>
    </div>

    <form method="post" id="quiz-form" action="/r3_quest_lrbd/{{count}}">
        {% csrf_token %}
        <input type="hidden" name="pro_lst" id="pro_lst" value="">
        <input type="hidden" name="dep_lst" id="dep_lst" value="">

        </form>

    <script type="text/javascript">
        const form = document.getElementById('quiz-form');
        const ProInput = document.getElementById('pro_lst');
        const DepInput = document.getElementById('dep_lst');

        let pro_lst = [];
        let dep_lst = [];
        // Timer and progress logic here...
        const progressBar = document.getElementById('progress');
            const totalQuestions = 8;
            const currentQuestion = parseInt('{{ counter }}', 10);
    
            if (totalQuestions > 0 && currentQuestion > 0) {
                const progressPercent = (currentQuestion / totalQuestions) * 100;
                if (progressPercent <= 100 && progressPercent >= 0) {
                    progressBar.style.width = progressPercent + '%';
                }
            }
        let url = `ws://${window.location.host}/ws/socket-server/`;
        const chatSocket = new WebSocket(url);
        let countdown;
        let timeRemaining = 10000; // 10 seconds in milliseconds
        let isRunning = false; 
        let timerInterval;

        function clearMessages() {
            document.getElementById("messages").innerHTML = '';
        }

        function updateTimerDisplay() {
            let seconds = (timeRemaining / 1000).toFixed(3);
            document.getElementById('timer').textContent = seconds;
        }

        function startTimer() {
            if (!isRunning) {
                timerInterval = setInterval(() => {
                    if (timeRemaining > 0) {
                        timeRemaining -= 10;
                        updateTimerDisplay();
                    } else {
                        clearInterval(timerInterval);
                        isRunning = false;
                    }
                }, 10);
                isRunning = true;
            }
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            isRunning = false;
        }

        function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                timeRemaining = 10000;
                event.preventDefault(); 
                toggleTimer();
                chatSocket.send(JSON.stringify({
                    'message': "kernel",
                    'play': true,
                    'quest': `{{quest}}`,
                    'option1': '{{quest.option1}}',
                    'option2': '{{quest.option2}}',
                    'option3': '{{quest.option3}}',
                    'option4': '{{quest.option4}}',
                    'counter': '{{counter}}'
                }));
                clearMessages();
            }

            if (event.code === 'Enter') {
                ProInput.value = JSON.stringify(pro_lst);  // Serialize pro_lst
                DepInput.value = JSON.stringify(dep_lst);  // Serialize dep_lst
                form.submit();
                // window.location.href = `/r3_quest_lrbd/{{count}}`;
            }

        });

        chatSocket.onmessage = function(e) {
            let data = JSON.parse(e.data);
            let messages = document.getElementById('messages');
            if (data.team !== undefined) {
                let tm = data.time;
                if(data.score>=0){
                    pro_lst.push({"team":data.team, "time":tm})
                }
                else{
                    dep_lst.push({"team":data.team})
                }
                messages.insertAdjacentHTML('beforeend', `<div><p>${data.team} ${(10.0 - tm).toFixed(3)}  ${data.score}</p></div>`);
            }
        };

        window.onload = function() {
            updateTimerDisplay();
        };
    </script>
</body>
</html>
